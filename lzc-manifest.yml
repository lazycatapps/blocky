# app çš„å”¯ä¸€ id,ä¸Šæ¶åˆ°å•†åº—éœ€è¦ä¿è¯ä¸è¦å†²çª,å°½é‡ä½¿ç”¨å¼€å‘è€…è‡ªå·±çš„åŸŸåä½œä¸ºåç¼€.
package: cloud.lazycat.app.liu.blocky
# app çš„ç‰ˆæœ¬
version: 0.27.0

name: Blocky
keyword: blocky,dns,ad-blocker,dns-proxy,adblock
description: åŸºäº Go çš„å¿«é€Ÿ DNS ä»£ç†å’Œå¹¿å‘Šæ‹¦æˆªå™¨

# è½¯ä»¶åç§°,ä¼šæ˜¾ç¤ºåœ¨å¯åŠ¨å™¨ä¹‹ç±»çš„åœ°æ–¹
locales:
  zh:
    name: Blocky DNS ä»£ç†
    description: |
      ## Blocky - DNS ä»£ç†å’Œå¹¿å‘Šæ‹¦æˆªå™¨

      **å®˜æ–¹ç½‘ç«™ï¼š** https://0xERR0R.github.io/blocky/
      **ä»“åº“åœ°å€ï¼š** https://github.com/lazycatapps/blocky.git

      Blocky æ˜¯ä¸€ä¸ªç”¨ Go ç¼–å†™çš„ DNS ä»£ç†å’Œå¹¿å‘Šæ‹¦æˆªå™¨ï¼Œä¸“ä¸ºæœ¬åœ°ç½‘ç»œä½¿ç”¨è®¾è®¡ï¼Œæä¾›å…¨é¢çš„è¿‡æ»¤å’Œ DNS ç®¡ç†åŠŸèƒ½ã€‚

      ## ä¸»è¦åŠŸèƒ½

      - ğŸ›¡ï¸ **DNS æŸ¥è¯¢æ‹¦æˆª**ï¼šä½¿ç”¨å¤–éƒ¨åˆ—è¡¨ï¼ˆå¹¿å‘Šæ‹¦æˆªã€æ¶æ„è½¯ä»¶ï¼‰è¿›è¡Œè¿‡æ»¤ï¼Œæ”¯æŒç™½åå•
      - ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ **å®¢æˆ·ç«¯åˆ†ç»„**ï¼šåŸºäºå®¢æˆ·ç«¯ç»„çš„è¿‡æ»¤ï¼ˆå¦‚å„¿ç«¥ã€æ™ºèƒ½å®¶å±…è®¾å¤‡ï¼‰
      - ğŸ” **æ·±åº¦æ£€æŸ¥**ï¼šæ‹¦æˆªè¯·æ±‚åŸŸåã€å“åº” CNAMEï¼ˆæ·±åº¦ CNAME æ£€æŸ¥ï¼‰å’Œå“åº” IP åœ°å€
      - ğŸ¯ **è‡ªå®šä¹‰è§£æ**ï¼šç‰¹å®šåŸŸåçš„è‡ªå®šä¹‰ DNS è§£æ
      - âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯å®šåˆ¶çš„ DNS ç­”æ¡ˆç¼“å­˜ï¼Œå‡å°‘å¤–éƒ¨æŸ¥è¯¢
      - ğŸ”„ **æ¡ä»¶è½¬å‘**ï¼šæ¡ä»¶è½¬å‘åˆ°å¤–éƒ¨ DNS æœåŠ¡å™¨
      - ğŸ” **å®‰å…¨åè®®**ï¼šæ”¯æŒ DNS over UDP/TCPã€DNS over HTTPS (DoH)ã€DNS over TLS (DoT)
      - ğŸ”’ **DNSSEC**ï¼šæ”¯æŒ DNSSEC å’Œ eDNS
      - ğŸ“Š **ç›‘æ§é›†æˆ**ï¼šPrometheus æŒ‡æ ‡ã€Grafana ä»ªè¡¨æ¿
      - ğŸ’¾ **æ•°æ®åº“æ—¥å¿—**ï¼šæ”¯æŒ MySQLã€PostgreSQLã€TimescaleDB
      - ğŸš€ **è½»é‡éƒ¨ç½²**ï¼šæ— çŠ¶æ€æ¶æ„ï¼ˆæ— éœ€æ•°æ®åº“ï¼‰ï¼Œå†…å­˜å ç”¨ä½

      ## ä½¿ç”¨æ–¹æ³•

      1. å¯åŠ¨åº”ç”¨åï¼ŒBlocky å°†è‡ªåŠ¨å¯åŠ¨å¹¶ç›‘å¬ UDP 53 ç«¯å£
      2. **é‡è¦ï¼š** éœ€è¦é€šè¿‡å±€åŸŸç½‘ç«¯å£è½¬å‘å·¥å…·ï¼ˆPort Forwarderï¼‰å°† LazyCat çš„å±€åŸŸç½‘ IP çš„ TCP & UDP 53 ç«¯å£æ˜ å°„åˆ°åº”ç”¨ä¸­ï¼Œæ‰èƒ½é€šè¿‡ LazyCat IP æ¥ä½œä¸º DNS æœåŠ¡å™¨ä½¿ç”¨
      3. å°†æ‚¨çš„è®¾å¤‡æˆ–è·¯ç”±å™¨çš„ DNS æœåŠ¡å™¨è®¾ç½®ä¸ºè¿è¡Œ Blocky çš„ä¸»æœº IP åœ°å€
      4. é€šè¿‡ä¿®æ”¹ LazyCat ä¸Šçš„ `/data/appvar/cloud.lazycat.app.liu.blocky/config/config.yml` é…ç½®æ–‡ä»¶æ¥è‡ªå®šä¹‰æ‹¦æˆªè§„åˆ™å’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨
      5. é‡å¯åº”ç”¨ä½¿é…ç½®ç”Ÿæ•ˆ
      6. è®¿é—®ç®¡ç†ç•Œé¢ï¼ˆå¦‚æœé…ç½®ï¼‰æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯å’Œç®¡ç†è§„åˆ™

      ## é…ç½®è¯´æ˜

      é…ç½®æ–‡ä»¶ä½äº LazyCat ä¸Šçš„ `/data/appvar/cloud.lazycat.app.liu.blocky/config/config.yml`ï¼Œæ‚¨å¯ä»¥é…ç½®ï¼š
      - ä¸Šæ¸¸ DNS æœåŠ¡å™¨
      - æ‹¦æˆªåˆ—è¡¨ï¼ˆå¹¿å‘Šã€æ¶æ„è½¯ä»¶ç­‰ï¼‰
      - ç™½åå•åŸŸå
      - å®¢æˆ·ç«¯åˆ†ç»„è§„åˆ™
      - ç¼“å­˜è®¾ç½®
      - æ—¥å¿—çº§åˆ«

      è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒï¼šhttps://0xERR0R.github.io/blocky/configuration/

  en:
    name: Blocky DNS Proxy
    description: |
      ## Blocky - DNS Proxy and Ad-Blocker

      **Official Website:** https://0xERR0R.github.io/blocky/
      **Repository:** https://github.com/lazycatapps/blocky.git

      Blocky is a DNS proxy and ad-blocker written in Go, designed for local network use with comprehensive filtering and DNS management capabilities.

      ## Main Features

      - ğŸ›¡ï¸ **DNS Query Blocking**: Filter using external lists (ad-block, malware) with allowlist support
      - ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ **Client Groups**: Group-based filtering (e.g., Kids, Smart home devices)
      - ğŸ” **Deep Inspection**: Block request domain, response CNAME (deep CNAME inspection) and response IP addresses
      - ğŸ¯ **Custom Resolution**: Custom DNS resolution for specific domains
      - âš¡ **Performance**: Customizable DNS answer caching to reduce external queries
      - ğŸ”„ **Conditional Forwarding**: Forward to external DNS servers conditionally
      - ğŸ” **Secure Protocols**: Support for DNS over UDP/TCP, DNS over HTTPS (DoH), DNS over TLS (DoT)
      - ğŸ”’ **DNSSEC**: DNSSEC and eDNS support
      - ğŸ“Š **Monitoring**: Prometheus metrics and Grafana dashboards
      - ğŸ’¾ **Database Logging**: Support for MySQL, PostgreSQL, TimescaleDB
      - ğŸš€ **Lightweight**: Stateless architecture (no database required), low memory footprint

      ## Usage Instructions

      1. After starting the application, Blocky will automatically start and listen on UDP port 53
      2. **Important:** You need to use the LAN Port Forwarder tool to map TCP & UDP port 53 from your LazyCat LAN IP to this application in order to use it as a DNS server via the LazyCat IP
      3. Set your device or router's DNS server to the IP address of the host running Blocky
      4. Customize blocking rules and upstream DNS servers by editing `/data/appvar/cloud.lazycat.app.liu.blocky/config/config.yml` on your LazyCat
      5. Restart the application to apply configuration changes
      6. Access the management interface (if configured) to view statistics and manage rules

      ## Configuration

      The configuration file is located at `/data/appvar/cloud.lazycat.app.liu.blocky/config/config.yml` on your LazyCat. You can configure:
      - Upstream DNS servers
      - Blocking lists (ads, malware, etc.)
      - Allowlist domains
      - Client group rules
      - Cache settings
      - Log level

      For detailed configuration instructions, please refer to: https://0xERR0R.github.io/blocky/configuration/

# è½¯ä»¶æœ¬èº«çš„ license
license: https://choosealicense.com/licenses/apache-2.0/

# è½¯ä»¶çš„ä¸»é¡µ,ä¼šåœ¨å•†åº—ç­‰åœ°æ–¹ä½“ç°
homepage: https://github.com/0xERR0R/blocky

# lpk çš„ä½œè€…,ä¼šåœ¨å•†åº—ç­‰åœ°æ–¹ä½“ç°
author: liu

# application ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ container è¿è¡Œï¼Œå¯¹åº”çš„ service åç§°ä¸ºå›ºå®šçš„`app`ï¼Œ å…¶ä»– service å¯ä»¥é€šè¿‡æ­¤åç§°ä¸ app è¿›è¡Œé€šè®¯
application:
  #æ˜¯å¦å­˜åœ¨åå°ä»»åŠ¡ï¼Œ è‹¥å­˜åœ¨åˆ™ç³»ç»Ÿä¸ä¼šå¯¹æ­¤ app è¿›è¡Œä¸»åŠ¨ä¼‘çœ ç­‰æ“ä½œ
  background_task: true

  # æœŸæœ›çš„ app åŸŸåï¼Œå¦‚æœç³»ç»Ÿä¸­å·²ç»æœ‰å¯¹åº”åŸŸååˆ™ä¼šæç¤ºç”¨æˆ·é€‰æ‹©å…¶ä»–åŸŸåã€‚ æœ€ç»ˆ app åˆ†é…åˆ°çš„åŸŸåä»¥/lzcapp/run/app.subdomain ä¸ºå‡†
  subdomain: blocky

  routes:
    # å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡
    - /=file:///lzcapp/pkg/content
    # å®é™…é¡µé¢
    # - /=http://blocky:4000

  # TCP/UDP æœåŠ¡é…ç½®
  ingress:
    - protocol: tcp                       # åè®®ç±»å‹ (tcp/udp)
      port: 4000                          # ç›®æ ‡ç«¯å£å· (ç•™ç©ºåˆ™ä½¿ç”¨å…¥ç«™ç«¯å£)
      service: blocky                     # æœåŠ¡å®¹å™¨åç§° (ç•™ç©ºåˆ™ä¸º app)
      description: blocky æœåŠ¡            # æœåŠ¡æè¿°
      publish_port: "4000"                # å…¥ç«™ç«¯å£å· (æ”¯æŒ "1000-50000" èŒƒå›´)
      send_port_info: false               # å‘é€ uint16 ç«¯å£ä¿¡æ¯ (little endian)
      yes_i_want_80_443: false            # å…è®¸ 80/443 æµé‡ (ç»•è¿‡ç³»ç»Ÿé‰´æƒ,æ…ç”¨!)

    - protocol: tcp
      port: 53
      service: dns
      description: DNS æœåŠ¡
      publish_port: "53"

    - protocol: udp
      port: 53
      service: dns
      description: DNS æœåŠ¡
      publish_port: "53"

  # å¥åº·æ£€æµ‹é…ç½®
  health_check:
    test_url: http://blocky:4000
    start_period: 60s

  depends_on:
    - blocky

  # æ˜¯å¦å¯ç”¨å¤šå®ä¾‹
  multi_instance: false

services:
  blocky:
    # lzc-cli appstore copy-image spoonest/blocky:latest
    image: registry.lazycat.cloud/liu/spx01/blocky:49ab8da37807a7e7
    environment:
      - TZ=Asia/Shanghai
      - BLOCKY_CONFIG_FILE=/config/config.yml
    binds:
      - /lzcapp/var/config:/config
    depends_on:
      - init-config

  init-config:
    # lzc-cli appstore copy-image alpine:latest
    image: registry.lazycat.cloud/liu/library/alpine:fa375aa75442b364
    setup_script: |
      CONFIG_DIR="/config"
      DEFAULT_DIR="/lzcapp/pkg/content/config"
      if [ ! -f /config/config.yml ]; then
        echo "No existing Master config found, copying default config."
        mkdir -p /config
        cp -f "${DEFAULT_DIR}/config.yml" "${CONFIG_DIR}/config.yml"
      else
        echo "Existing config found, skipping copy."
        cat /config/config.yml
      fi

      # Create a marker file to indicate initialization is complete
      touch /tmp/init-complete

      sleep infinity
    binds:
      - /lzcapp/var/config:/config
    health_check:
      test:
        - CMD
        - test
        - -f
        - /tmp/init-complete

unsupported_platforms:
  - ios
  - android
  - tvos
